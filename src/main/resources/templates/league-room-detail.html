<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦¬ê·¸ ë°© ìƒì„¸ì •ë³´</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="container">
    <header>
        <h1><a href="/">PingPong League</a></h1>
        <nav>
            <a th:href="@{/}" class="btn btn-secondary">í™ˆìœ¼ë¡œ</a>
        </nav>
    </header>

    <main>
        <div class="detail-container">
            <div class="detail-header">
                <span class="location-badge" th:text="${leagueRoom.location}"></span>
                <h1 th:text="${leagueRoom.title}">League Title</h1>
                <div class="detail-info">
                    <p>ì¼ì‹œ: <strong th:text="${#temporals.format(leagueRoom.eventDateTime, 'yyyy.MM.dd HH:mm')}"></strong></p>
                </div>
                <div class="detail-info">
                    <p>ë°©ì¥: <span th:text="${leagueRoom.ownerUsername}"></span></p>
                    <p>ìƒíƒœ: <span id="room-status-text" th:text="${leagueRoom.status.displayName}"></span></p>
                </div>
                <div class="detail-info">
                    <p>ê²½ê¸° ë°©ì‹: <span th:text="${leagueRoom.gameType.displayName}"></span></p>
                    <p>ìš´ì˜ ë°©ì‹: <span th:text="${leagueRoom.matchFormat.displayName}"></span></p>
                    <p th:if="${leagueRoom.matchFormat.name() == 'ROUND_ROBIN' or leagueRoom.matchFormat.name() == 'PRELIMINARY_TOURNAMENT'}">
                        í’€ë¦¬ê·¸ ê¸°ì¤€: <span th:text="${leagueRoom.roundRobinRankingType != null ? leagueRoom.roundRobinRankingType.displayName : '-'}"></span>
                    </p>
                    <p th:if="${leagueRoom.gameType.name() == 'TEAM'}">
                        ë‹¨ì²´ì „ ì¸ì›: <span th:text="${leagueRoom.teamSize != null ? leagueRoom.teamSize + 'ì¸' : '-'}"></span>
                    </p>
                    <p th:if="${leagueRoom.gameType.name() == 'TEAM'}">
                        ë‹¨ì²´ì „ êµ¬ì„±: <span th:text="${leagueRoom.teamMatchFormat != null ? leagueRoom.teamMatchFormat.displayName : '-'}"></span>
                    </p>
                    <p>ì¡°ë³„ ì¸ì›: <span th:text="${leagueRoom.playersPerGroup} + 'ëª…'"></span></p>
                    <p th:if="${leagueRoom.matchFormat.name() == 'PRELIMINARY_TOURNAMENT'}">
                        ë³¸ì„  ì§„ì¶œ: <span th:text="'ì¡°ë‹¹ ' + ${leagueRoom.advancingPlayersPerGroup} + 'ëª…'"></span>
                    </p>
                    <p th:if="${leagueRoom.tournamentType != null}">
                        í† ë„ˆë¨¼íŠ¸: <span th:text="${leagueRoom.tournamentType.displayName}"></span>
                    </p>
                </div>
                <div class="detail-info">
                    <p>ê²½ê¸°ì¥ ì£¼ì†Œ: <span th:text="${leagueRoom.venueAddress != null ? leagueRoom.venueAddress : '-'}"></span></p>
                    <p>ì—°ë½ì²˜: <span th:text="${leagueRoom.contactInfo != null ? leagueRoom.contactInfo : '-'}"></span></p>
                </div>
                <div class="detail-info">
                    <p>ê²½ê¸° ë°©ì‹ ì„¤ëª…: <span th:text="${leagueRoom.matchDescription != null ? leagueRoom.matchDescription : '-'}"></span></p>
                </div>
            </div>

            <div class="participants-section">
                <h2>ì°¸ê°€ì (<span id="participant-count">0</span> / <span th:text="${leagueRoom.maxParticipants}"></span>)</h2>
                <ul id="participants-list" class="participants-list">
                </ul>
            </div>

            <div class="participants-manage"
                 th:if="${leagueRoom.ownerUsername == #authentication.name and leagueRoom.status.name() == 'OPEN'}">
                <h2>ì°¸ê°€ì ì¶”ê°€</h2>
                <div class="manage-grid">
                    <div class="manage-card">
                        <h4>ë‹¨ì¼ ì¶”ê°€</h4>
                        <input type="text" id="participant-identifier" list="participant-suggestions" placeholder="ì•„ì´ë”” ë˜ëŠ” ë‹‰ë„¤ì„">
                        <datalist id="participant-suggestions"></datalist>
                        <button type="button" id="add-participant-btn" class="btn btn-primary">ì¶”ê°€</button>
                    </div>
                    <div class="manage-card">
                        <h4>ì¼ê´„ ì¶”ê°€</h4>
                        <textarea id="bulk-participants" rows="4" placeholder="ì•„ì´ë””/ë‹‰ë„¤ì„ì„ ì¤„ë°”ê¿ˆ ë˜ëŠ” ì‰¼í‘œë¡œ ì…ë ¥"></textarea>
                        <button type="button" id="bulk-add-btn" class="btn btn-secondary">ì¼ê´„ ì¶”ê°€</button>
                    </div>
                    <div class="manage-card">
                        <h4>ê²ŒìŠ¤íŠ¸ ì¶”ê°€</h4>
                        <input type="text" id="guest-nickname" placeholder="ê²ŒìŠ¤íŠ¸ ë‹‰ë„¤ì„">
                        <button type="button" id="guest-add-btn" class="btn btn-secondary">ê²ŒìŠ¤íŠ¸ ì¶”ê°€</button>
                    </div>
                </div>
            </div>

            <div class="team-assignment"
                 id="team-assignment-section"
                 th:if="${leagueRoom.ownerUsername == #authentication.name and leagueRoom.status.name() == 'OPEN' and leagueRoom.gameType.name() == 'TEAM'}">
                <h2>íŒ€ êµ¬ì„±</h2>
                <p class="team-assignment-hint">
                    íŒ€ë‹¹ ì¸ì›: <strong th:text="${leagueRoom.teamSize != null ? leagueRoom.teamSize + 'ëª…' : '2ëª…'}"></strong>
                </p>
                <div class="team-assignment-actions">
                    <button type="button" id="auto-team-btn" class="btn btn-secondary">ìë™ íŒ€ êµ¬ì„±</button>
                    <button type="button" id="save-team-btn" class="btn btn-primary">íŒ€ êµ¬ì„± ì €ì¥</button>
                </div>
                <div id="team-assignment-list" class="team-assignment-list"></div>
            </div>

            <div sec:authorize="isAuthenticated()" class="actions-grid">

                <form id="join-form" th:if="${leagueRoom.status.name() == 'OPEN' and !#lists.contains(leagueRoom.participants, #authentication.name)}">
                    <button type="submit" class="btn btn-primary">ë¦¬ê·¸ ì°¸ê°€</button>
                </form>

                <form id="leave-form" th:if="${leagueRoom.status.name() == 'OPEN' and #lists.contains(leagueRoom.participants, #authentication.name)}">
                    <button type="submit" class="btn btn-danger">ì°¸ê°€ ì·¨ì†Œ</button>
                </form>

                <form id="start-form" th:if="${leagueRoom.ownerUsername == #authentication.name and leagueRoom.status.name() == 'OPEN'}">
                    <button type="submit" class="btn btn-primary">ë¦¬ê·¸ ì‹œì‘</button>
                </form>
                <a th:if="${leagueRoom.ownerUsername == #authentication.name and leagueRoom.status.name() == 'OPEN'}" th:href="@{/league-rooms/{roomId}/edit(roomId=${leagueRoom.id})}" class="btn btn-secondary">ì •ë³´ ìˆ˜ì •</a>

                <a th:if="${leagueRoom.ownerUsername == #authentication.name and leagueRoom.status.name() != 'OPEN'}" th:href="@{/league-rooms/{roomId}/matches(roomId=${leagueRoom.id})}" class="btn btn-secondary">ëŒ€ì§„í‘œ ë³´ê¸°</a>

                <form id="reopen-form" th:if="${leagueRoom.ownerUsername == #authentication.name and leagueRoom.status.name() == 'IN_PROGRESS'}">
                    <button type="submit" class="btn btn-secondary">ë‹¤ì‹œ ëª¨ì§‘í•˜ê¸°</button>
                </form>
                <form id="complete-form" th:if="${leagueRoom.ownerUsername == #authentication.name and leagueRoom.status.name() == 'IN_PROGRESS'}">
                    <button type="submit" class="btn btn-primary">ë¦¬ê·¸ ì¢…ë£Œ</button>
                </form>

                <a href="#" id="view-results-btn" class="btn btn-secondary" th:if="${leagueRoom.ownerUsername == #authentication.name and leagueRoom.status.name() == 'COMPLETED'}">ìµœì¢… ê²°ê³¼ ë³´ê¸°</a>

                <form id="delete-form" th:if="${leagueRoom.ownerUsername == #authentication.name}">
                    <button type="submit" class="btn btn-danger">ë¦¬ê·¸ ë°© ì‚­ì œ</button>
                </form>
            </div>

        </div>
    </main>
</div>

<style>
    .btn-danger {
        background-color: var(--error-color);
        color: #fff;
    }
    .btn-danger:hover {
        background-color: #c82333;
        transform: translateY(-2px);
    }

    .participants-manage {
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--card-bg);
        border-radius: 16px;
        border: 1px solid var(--border-color);
    }

    .manage-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .manage-card {
        background: #1f1f1f;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
    }

    .manage-card h4 {
        margin: 0;
        font-size: 1rem;
        color: var(--text-light);
    }

    .manage-card input,
    .manage-card textarea {
        width: 100%;
        padding: 0.8rem 0.9rem;
        border-radius: 10px;
        border: 1px solid #333;
        background: var(--input-bg);
        color: var(--text-light);
        font-size: 0.95rem;
    }

    .team-assignment {
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--card-bg);
        border-radius: 16px;
        border: 1px solid var(--border-color);
    }

    .team-assignment-hint {
        margin: 0.2rem 0 1rem;
        color: var(--text-muted);
        font-size: 0.95rem;
    }

    .team-assignment-actions {
        display: flex;
        gap: 0.8rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .team-assignment-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1rem;
    }

    .team-row {
        background: #1f1f1f;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
    }

    .team-row input,
    .team-row select {
        width: 100%;
        padding: 0.7rem 0.8rem;
        border-radius: 10px;
        border: 1px solid #333;
        background: var(--input-bg);
        color: var(--text-light);
        font-size: 0.9rem;
    }

    .team-members {
        display: grid;
        gap: 0.5rem;
    }

    @media (max-width: 900px) {
        .participants-manage {
            padding: 1rem;
        }
        .manage-card {
            padding: 0.9rem;
        }
        .team-assignment {
            padding: 1rem;
        }
    }
</style>

<script th:inline="javascript">
    const roomId = /*[[${leagueRoom.id}]]*/ null;

    // ëª¨ë“  JSì½”ë“œë¥¼ DOMContentLoaded ì•ˆì— ë„£ì–´ì„œ ë¡œë”© ìˆœì„œ ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
    document.addEventListener('DOMContentLoaded', function() {
        const listElement = document.getElementById('participants-list');
        const countElement = document.getElementById('participant-count');
        const isOwner = /*[[${leagueRoom.ownerUsername == #authentication.name}]]*/ false;
        const ownerUsername = /*[[${leagueRoom.ownerUsername}]]*/ '';
        const maxParticipants = /*[[${leagueRoom.maxParticipants}]]*/ 0;
        const roomStatus = /*[[${leagueRoom.status.name()}]]*/ '';
        const teamSize = /*[[${leagueRoom.teamSize}]]*/ 0;
        const gameType = /*[[${leagueRoom.gameType.name()}]]*/ '';
        const teamAssignmentSection = document.getElementById('team-assignment-section');
        const teamListElement = document.getElementById('team-assignment-list');
        const autoTeamBtn = document.getElementById('auto-team-btn');
        const saveTeamBtn = document.getElementById('save-team-btn');
        const participantInput = document.getElementById('participant-identifier');
        const suggestionList = document.getElementById('participant-suggestions');
        let participantsCache = [];
        let teamsCache = null;
        let searchTimer = null;

        function loadParticipants() {
            fetch(`/api/league-rooms/${roomId}/participants-with-id`)
                .then(response => response.json())
                .then(participants => {
                    participantsCache = participants;
                    listElement.innerHTML = '';
                    countElement.textContent = participants.length;
                    if (participants.length === 0) {
                        listElement.innerHTML = '<li>ì•„ì§ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                    } else {
                        participants.forEach(p => {
                            const li = document.createElement('li');
                            li.textContent = p.nickname;
                            if (isOwner && p.nickname !== ownerUsername) {
                                const removeBtn = document.createElement('button');
                                removeBtn.textContent = 'Ã—';
                                removeBtn.className = 'btn-remove-participant';
                                removeBtn.dataset.participantId = p.id;
                                li.appendChild(removeBtn);
                            }
                            listElement.appendChild(li);
                        });
                    }

                    const statusTextEl = document.getElementById('room-status-text');
                    if (statusTextEl && roomStatus === 'OPEN' && participants.length >= maxParticipants) {
                        statusTextEl.textContent = 'ëª¨ì§‘ì™„ë£Œ';
                    }

                    renderTeamAssignment(teamsCache);
                });
        }

        loadParticipants();

        // [ì¶”ê°€] ì‚­ì œ ë²„íŠ¼ì— ëŒ€í•œ ì´ë²¤íŠ¸ ìœ„ì„(Event Delegation) ì„¤ì •
        listElement.addEventListener('click', function(event) {
            if (event.target && event.target.matches('.btn-remove-participant')) {
                const participantId = event.target.dataset.participantId;
                const participantName = event.target.parentElement.firstChild.textContent;
                if (confirm(`'${participantName}' ë‹˜ì„ ì°¸ê°€ì ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    fetch(`/api/league-rooms/${roomId}/participants/${participantId}`, { method: 'DELETE' })
                        .then(async response => {
                            if (response.ok) {
                                alert('ì°¸ê°€ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                loadParticipants();
                            } else {
                                alert((await response.json()).message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            }
                        });
                }
            }
        });

        const addParticipantBtn = document.getElementById('add-participant-btn');
        const bulkAddBtn = document.getElementById('bulk-add-btn');
        const guestAddBtn = document.getElementById('guest-add-btn');

        if (participantInput && suggestionList) {
            participantInput.addEventListener('input', function() {
                const query = participantInput.value.trim();
                if (query.length < 2) {
                    suggestionList.innerHTML = '';
                    return;
                }
                clearTimeout(searchTimer);
                searchTimer = setTimeout(() => {
                    fetch(`/api/users/search?query=${encodeURIComponent(query)}`)
                        .then(response => response.ok ? response.json() : [])
                        .then(users => {
                            suggestionList.innerHTML = '';
                            users.forEach(user => {
                                const option = document.createElement('option');
                                option.value = user.nickname;
                                option.label = user.username;
                                suggestionList.appendChild(option);
                            });
                        })
                        .catch(() => {
                            suggestionList.innerHTML = '';
                        });
                }, 250);
            });
        }

        if (addParticipantBtn) {
            addParticipantBtn.addEventListener('click', function() {
                const identifier = document.getElementById('participant-identifier').value.trim();
                if (!identifier) return alert('ì•„ì´ë”” ë˜ëŠ” ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                fetch(`/api/league-rooms/${roomId}/participants`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier })
                })
                    .then(async response => {
                        if (response.ok) {
                            alert('ì°¸ê°€ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            document.getElementById('participant-identifier').value = '';
                            loadParticipants();
                        } else {
                            const error = await response.json();
                            alert(error.message || 'ì°¸ê°€ì ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    });
            });
        }

        if (bulkAddBtn) {
            bulkAddBtn.addEventListener('click', function() {
                const raw = document.getElementById('bulk-participants').value;
                const identifiers = raw.split(/[\n,]+/).map(v => v.trim()).filter(Boolean);
                if (identifiers.length === 0) return alert('ì¶”ê°€í•  ì•„ì´ë””/ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                fetch(`/api/league-rooms/${roomId}/participants/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifiers })
                })
                    .then(async response => {
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'ì¼ê´„ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                        return response.json();
                    })
                    .then(result => {
                        const addedCount = result.added ? result.added.length : 0;
                        const failedCount = result.failed ? result.failed.length : 0;
                        let message = `ì¶”ê°€ ì™„ë£Œ: ${addedCount}ëª…`;
                        if (failedCount > 0) {
                            const reasons = result.failed.map(f => `${f.identifier} (${f.reason})`).join('\\n');
                            message += `\\nì‹¤íŒ¨: ${failedCount}ëª…\\n${reasons}`;
                        }
                        alert(message);
                        document.getElementById('bulk-participants').value = '';
                        loadParticipants();
                    })
                    .catch(error => alert(error.message));
            });
        }

        if (guestAddBtn) {
            guestAddBtn.addEventListener('click', function() {
                const nickname = document.getElementById('guest-nickname').value.trim();
                if (!nickname) return alert('ê²ŒìŠ¤íŠ¸ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                fetch(`/api/league-rooms/${roomId}/participants/guest`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname })
                })
                    .then(async response => {
                        if (response.ok) {
                            alert('ê²ŒìŠ¤íŠ¸ ì°¸ê°€ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            document.getElementById('guest-nickname').value = '';
                            loadParticipants();
                        } else {
                            const error = await response.json();
                            alert(error.message || 'ê²ŒìŠ¤íŠ¸ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    });
            });
        }

        function renderTeamAssignment(teams) {
            if (!teamAssignmentSection || gameType !== 'TEAM' || !teamListElement) {
                return;
            }
            if (!participantsCache.length) {
                teamListElement.innerHTML = '<p>ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const resolvedTeamSize = teamSize || 2;
            const teamCount = Math.ceil(participantsCache.length / resolvedTeamSize);
            const sourceTeams = (teams && teams.length) ? teams : (teamsCache && teamsCache.length ? teamsCache : []);
            const normalizedTeams = sourceTeams.length
                ? sourceTeams
                : Array.from({ length: teamCount }, (_, index) => {
                    const start = index * resolvedTeamSize;
                    const memberIds = participantsCache
                        .slice(start, start + resolvedTeamSize)
                        .map(member => member.id);
                    return { name: `íŒ€ ${index + 1}`, memberIds };
                });

            teamListElement.innerHTML = '';
            normalizedTeams.forEach((team, index) => {
                const row = document.createElement('div');
                row.className = 'team-row';
                row.dataset.teamIndex = index;

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.placeholder = `íŒ€ ${index + 1}`;
                nameInput.value = team.name || `íŒ€ ${index + 1}`;
                nameInput.className = 'team-name-input';

                const membersWrap = document.createElement('div');
                membersWrap.className = 'team-members';

                const memberIds = Array.isArray(team.memberIds) ? team.memberIds : [];
                for (let slot = 0; slot < resolvedTeamSize; slot += 1) {
                    const select = document.createElement('select');
                    select.className = 'team-member-select';

                    const blankOption = document.createElement('option');
                    blankOption.value = '';
                    blankOption.textContent = `íŒ€ì› ${slot + 1}`;
                    select.appendChild(blankOption);

                    participantsCache.forEach(member => {
                        const option = document.createElement('option');
                        option.value = String(member.id);
                        option.textContent = member.nickname;
                        select.appendChild(option);
                    });

                    if (memberIds[slot]) {
                        select.value = String(memberIds[slot]);
                    }
                    membersWrap.appendChild(select);
                }

                row.appendChild(nameInput);
                row.appendChild(membersWrap);
                teamListElement.appendChild(row);
            });
        }

        function collectTeamPayload() {
            if (!teamListElement) return [];
            const rows = Array.from(teamListElement.querySelectorAll('.team-row'));
            return rows.map(row => {
                const name = row.querySelector('.team-name-input')?.value?.trim() || '';
                const selects = Array.from(row.querySelectorAll('.team-member-select'));
                const memberIds = selects
                    .map(select => select.value)
                    .filter(Boolean)
                    .map(value => Number(value));
                return { name, memberIds };
            });
        }

        function validateTeamPayload(payload) {
            const resolvedTeamSize = teamSize || 2;
            const allIds = [];
            for (const team of payload) {
                if (team.memberIds.length !== resolvedTeamSize) {
                    alert('ê° íŒ€ì˜ ì¸ì›ìˆ˜ë¥¼ ë§ì¶°ì£¼ì„¸ìš”.');
                    return false;
                }
                allIds.push(...team.memberIds);
            }
            const uniqueIds = new Set(allIds);
            if (uniqueIds.size !== allIds.length) {
                alert('ê°™ì€ ì°¸ê°€ìê°€ ì—¬ëŸ¬ íŒ€ì— ë°°ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return false;
            }
            if (uniqueIds.size !== participantsCache.length) {
                const assignedIds = new Set(allIds);
                const unassigned = participantsCache
                    .filter(member => !assignedIds.has(member.id))
                    .map(member => member.nickname);
                alert(`ë°°ì •ë˜ì§€ ì•Šì€ ì°¸ê°€ì: ${unassigned.join(', ')}`);
                return false;
            }
            return true;
        }

        function loadTeams() {
            if (!teamAssignmentSection) return Promise.resolve([]);
            return fetch(`/api/league-rooms/${roomId}/teams`)
                .then(response => response.ok ? response.json() : [])
                .then(teams => {
                    teamsCache = teams;
                    return teams;
                })
                .catch(() => []);
        }

        if (teamAssignmentSection) {
            loadTeams().then(renderTeamAssignment);
        }

        if (autoTeamBtn) {
            autoTeamBtn.addEventListener('click', function() {
                fetch(`/api/league-rooms/${roomId}/teams/auto`, { method: 'POST' })
                    .then(async response => {
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'ìë™ íŒ€ êµ¬ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                        return response.json();
                    })
                    .then(teams => {
                        teamsCache = teams;
                        renderTeamAssignment(teams);
                        alert('ìë™ íŒ€ êµ¬ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    })
                    .catch(error => alert(error.message));
            });
        }

        if (saveTeamBtn) {
            saveTeamBtn.addEventListener('click', function() {
                const payload = collectTeamPayload();
                if (!validateTeamPayload(payload)) return;
                fetch(`/api/league-rooms/${roomId}/teams`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ teams: payload })
                })
                    .then(async response => {
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.message || 'íŒ€ êµ¬ì„± ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                        return response.json();
                    })
                    .then(teams => {
                        teamsCache = teams;
                        renderTeamAssignment(teams);
                        alert('íŒ€ êµ¬ì„±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    })
                    .catch(error => alert(error.message));
            });
        }

        // --- ëª¨ë“  í¼/ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ ---
        const joinForm = document.getElementById('join-form');
        if (joinForm) {
            joinForm.addEventListener('submit', function(event) {
                event.preventDefault();
                fetch(`/api/league-rooms/${roomId}/join`, { method: 'POST' })
                    .then(async response => {
                        if (response.ok) {
                            alert('ë¦¬ê·¸ ì°¸ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            window.location.reload();
                        } else {
                            alert((await response.json()).message || 'ë¦¬ê·¸ ì°¸ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    });
            });
        }

        const leaveForm = document.getElementById('leave-form');
        if (leaveForm) {
            leaveForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (confirm('ì •ë§ë¡œ ë¦¬ê·¸ ì°¸ê°€ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    fetch(`/api/league-rooms/${roomId}/participants`, { method: 'DELETE' })
                        .then(async response => {
                            if (response.ok) {
                                alert('ì°¸ê°€ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                window.location.reload();
                            } else {
                                alert((await response.json()).message || 'ì°¸ê°€ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            }
                        });
                }
            });
        }

        const startForm = document.getElementById('start-form');
        if (startForm) {
            startForm.addEventListener('submit', function(event) {
                event.preventDefault();
                fetch(`/api/league-rooms/${roomId}/start`, { method: 'POST' })
                    .then(async response => {
                        if (response.ok) {
                            alert('ë¦¬ê·¸ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ëŒ€ì§„í‘œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                            window.location.href = `/league-rooms/${roomId}/matches`;
                        } else {
                            alert((await response.json()).message || 'ë¦¬ê·¸ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    });
            });
        }

        const reopenForm = document.getElementById('reopen-form');
        if(reopenForm) {
            reopenForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (confirm('ì •ë§ë¡œ ë¦¬ê·¸ë¥¼ ë‹¤ì‹œ ëª¨ì§‘ ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ ëŒ€ì§„í‘œëŠ” ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
                    fetch(`/api/league-rooms/${roomId}/reopen`, { method: 'POST' })
                        .then(async response => {
                            if(response.ok) {
                                alert('ë¦¬ê·¸ê°€ ë‹¤ì‹œ ëª¨ì§‘ ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                window.location.reload();
                            } else {
                                alert((await response.json()).message || 'ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            }
                        });
                }
            });
        }

        const completeForm = document.getElementById('complete-form');
        if(completeForm) {
            completeForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (confirm('ì •ë§ë¡œ ë¦¬ê·¸ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì¢…ë£Œ í›„ì—ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                    fetch(`/api/league-rooms/${roomId}/complete`, { method: 'POST' })
                        .then(async response => {
                            if(response.ok) {
                                alert('ë¦¬ê·¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                window.location.reload();
                            } else {
                                alert((await response.json()).message || 'ë¦¬ê·¸ ì¢…ë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            }
                        });
                }
            });
        }

        const deleteForm = document.getElementById('delete-form');
        if(deleteForm) {
            deleteForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (confirm('ì •ë§ë¡œ ì´ ë¦¬ê·¸ ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                    fetch(`/api/league-rooms/${roomId}`, { method: 'DELETE' })
                        .then(response => {
                            if(response.status === 204) { // No Content
                                alert('ë¦¬ê·¸ ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                window.location.href = '/';
                            } else {
                                alert('ë¦¬ê·¸ ë°© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            }
                        });
                }
            });
        }

        // ìµœì¢… ê²°ê³¼ ëª¨ë‹¬ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸
        const viewResultsBtn = document.getElementById('view-results-btn');
        const resultsModal = document.getElementById('final-results-modal');
        const modals = document.querySelectorAll('.modal-overlay');

        if (viewResultsBtn && resultsModal) {
            viewResultsBtn.addEventListener('click', function(event) {
                event.preventDefault();
                const resultsContent = document.getElementById('results-content');

                fetch(`/api/league-rooms/${roomId}/final-results`)
                    .then(response => {
                        if (!response.ok) throw new Error('ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        return response.json();
                    })
                    .then(data => {
                        if(resultsContent) {
                            if (Array.isArray(data.rankings) && data.rankings.length > 0) {
                                const rankingHtml = data.rankings.map(row => `<li>${row}</li>`).join('');
                                resultsContent.innerHTML = `
                                    <div style="text-align: left;">
                                        <p style="font-size: 1.2rem; margin-bottom: 0.6rem;">ğŸ“‹ <strong>ìµœì¢… ìˆœìœ„</strong></p>
                                        <ul style="list-style: none; padding-left: 1rem; margin: 0;">${rankingHtml}</ul>
                                    </div>
                                `;
                            } else {
                                const firstPlaceHtml = data.winner.split(', ').map(name => `<li>${name}</li>`).join('');
                                const secondPlaceHtml = data.runnerUp.split(', ').map(name => `<li>${name}</li>`).join('');
                                const thirdPlaceHtml = data.jointThird.map(name => `<li>${name}</li>`).join('');

                                resultsContent.innerHTML = `
                                <div style="text-align: left; margin-bottom: 1.5rem;">
                                    <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">ğŸ¥‡ <strong>1ìœ„</strong></p>
                                    <ul style="list-style: none; padding-left: 1rem;">${firstPlaceHtml}</ul>
                                </div>
                                <div style="text-align: left; margin-bottom: 1.5rem;">
                                    <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">ğŸ¥ˆ <strong>2ìœ„</strong></p>
                                    <ul style="list-style: none; padding-left: 1rem;">${secondPlaceHtml}</ul>
                                </div>
                                <div style="text-align: left;">
                                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">ğŸ¥‰ <strong>3ìœ„</strong></p>
                                    <ul style="list-style: none; padding-left: 1rem;">${thirdPlaceHtml}</ul>
                                </div>
                            `;
                            }
                        }
                        resultsModal.classList.add('visible');
                    })
                    .catch(error => alert(error.message));
            });
        }

        // ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸° ê¸°ëŠ¥
        modals.forEach(modal => {
            const closeButton = modal.querySelector('.modal-close');
            if (closeButton) {
                closeButton.addEventListener('click', () => modal.classList.remove('visible'));
            }
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.classList.remove('visible');
                }
            });
        });
    });
</script>
<div id="final-results-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ† ìµœì¢… ê²°ê³¼ ğŸ†</h2>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body" style="text-align: center;">
            <div id="results-content">
            </div>
        </div>
    </div>
</div>
</body>
</html>
